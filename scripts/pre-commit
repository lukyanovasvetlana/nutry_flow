#!/bin/bash

# Pre-commit —Ö—É–∫ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –∫–æ–¥–∞ NutryFlow
# –ê–≤—Ç–æ—Ä: AI Assistant
# –î–∞—Ç–∞: $(date)

echo "üîç Pre-commit: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${GREEN}[PRE-COMMIT]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[PRE-COMMIT]${NC} $1"
}

error() {
    echo -e "${RED}[PRE-COMMIT]${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -f "pubspec.yaml" ]; then
    error "Pre-commit —Ö—É–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –®–∞–≥ 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
log "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
dart format lib/ --set-exit-if-changed
if [ $? -eq 0 ]; then
    log "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ"
    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–æ–º–º–∏—Ç
    git add -A
else
    warn "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã"
fi

# –®–∞–≥ 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤
log "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤..."
dart fix --apply
if [ $? -eq 0 ]; then
    log "–ò–º–ø–æ—Ä—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–æ–º–º–∏—Ç
    git add -A
else
    warn "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
fi

# –®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
log "–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞..."
ANALYSIS_OUTPUT=$(flutter analyze --no-fatal-infos 2>&1)
ISSUES_COUNT=$(echo "$ANALYSIS_OUTPUT" | grep -c "issues found" || echo "0")

if [ "$ISSUES_COUNT" -gt 0 ]; then
    warn "–ù–∞–π–¥–µ–Ω–æ $ISSUES_COUNT –ø—Ä–æ–±–ª–µ–º –≤ –∫–æ–¥–µ"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
    CRITICAL_ISSUES=$(echo "$ANALYSIS_OUTPUT" | grep -E "(error|unused_import|unused_element|unused_field)" | head -5)
    if [ ! -z "$CRITICAL_ISSUES" ]; then
        echo ""
        warn "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:"
        echo "$CRITICAL_ISSUES"
        echo ""
        
        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ö–æ—á–µ—Ç –ª–∏ –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        read -p "–ù–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–º–º–∏—Ç? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            error "–ö–æ–º–º–∏—Ç –æ—Ç–º–µ–Ω–µ–Ω. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
            exit 1
        fi
    fi
else
    log "–ü—Ä–æ–±–ª–µ–º –≤ –∫–æ–¥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi

# –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤
log "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
flutter test --no-pub --reporter=compact
if [ $? -ne 0 ]; then
    error "–¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏. –ö–æ–º–º–∏—Ç –æ—Ç–º–µ–Ω–µ–Ω."
    exit 1
fi

# –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏
log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏..."
flutter build apk --debug --no-pub || flutter build ios --debug --no-pub
if [ $? -ne 0 ]; then
    warn "–°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –Ω–æ –∫–æ–º–º–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω"
else
    log "–°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞"
fi

# –®–∞–≥ 6: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
log "–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
if git diff --cached --quiet; then
    log "–ò–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
else
    log "–ò–∑–º–µ–Ω–µ–Ω–∏—è –≥–æ—Ç–æ–≤—ã –∫ –∫–æ–º–º–∏—Ç—É"
fi

log "Pre-commit –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! ‚úÖ"
exit 0
