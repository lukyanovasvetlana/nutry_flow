# Задача: Создание архитектуры (Flutter приложения)

## Назначение

- Спроектировать полную, надёжную и хорошо документированную техническую архитектуру на основе требований проекта (PRD, эпики, brief), результатов исследований и пользовательского ввода.
- Сделать чёткий выбор технологий и обосновать его, используя шаблон архитектуры как структурный ориентир.
- Подготовить все необходимые технические артефакты, чтобы архитектура была оптимизирована для быстрой реализации (особенно AI-агентами), и валидировать её по `architect-checklist`.
- Все решения, шаблоны и стандарты должны учитывать специфику мобильной Flutter-разработки: feature-based архитектура, BLoC, Supabase, Firebase, CI/CD, тестирование, документация, UX, мобильные best practices.

## Инструкции

1. **Анализ входных данных и старт диалога:**
    - Убедись, что есть все необходимые входные данные: PRD (особенно разделы "Технические допущения" и "Initial Architect Prompt" с описанием репозитория и сервисной архитектуры), project brief, отчёты исследований, опционально `technical-preferences.md`. Запроси недостающие критические документы.
    - Внимательно изучи все входные данные.
    - Суммируй ключевые технические требования, ограничения, нефункциональные требования (NFR), выбранную архитектуру репозитория/сервисов. Покажи этот summary пользователю для подтверждения и общего понимания.
    - Поделись первыми архитектурными наблюдениями, потенциальными сложностями или вопросами.
    - **Выбор режима взаимодействия:**
      - Спроси пользователя: "Как будем создавать архитектуру?
        a. Инкрементально (по секциям, с ревью каждого шага) — рекомендуется для сложных решений.
        b. YOLO (сразу драфт всего или крупных частей, потом итерации) — быстрее, но менее детально."
      - Дождись выбора пользователя и подтверди режим.

2. **Уточнение и сбор недостающей информации:**
    - Если чего-то не хватает или есть неясности — задай конкретные вопросы.
    - **Внешние API:** Если нужны интеграции с внешними API (например, Supabase, Firebase, сторонние сервисы), а "Deep Research" по ним не проводился:
      - Запроси у пользователя ссылки на официальную документацию, примеры запросов/ответов (cURL, JSON), схемы ошибок.
      - Объясни, что это критично для точного описания API-контрактов, фасадов/адаптеров и технического планирования.
    - Сгруппируй вопросы и дождись ответов.
    - Зафиксируй все решения и уточнения.

3. **Выбор технологий и проектирование (интерактивно, если не YOLO):**
    - Для каждого крупного архитектурного компонента (например, фреймворк, DI, state management, база данных, облако, ключевые сервисы, паттерны коммуникации):
      - Если есть варианты — представь 2-3 опции с кратким разбором плюсов/минусов и их релевантности для Flutter/мобильной разработки.
      - Дай свою рекомендацию с аргументацией (учитывай требования, исследования, предпочтения из `technical-preferences.md`, best practices Flutter).
      - Запроси фидбек пользователя, обсуди вопросы, получи явное одобрение.
      - Зафиксируй выбор и обоснование в архитектурном документе.
    - **Starter templates:** Если релевантно — предложи подходящие стартеры или оцени существующий код, объясни соответствие целям проекта, запроси подтверждение.

4. **Создание технических артефактов (по шаблону architecture-tmpl):**
    - Для каждого раздела архитектурного документа:
      - **Объясни цель раздела** и что он будет покрывать.
      - **Драфтируй по секциям:** Показывай драфт одной логической секции за раз.
        - Убедись, что High-Level Overview и Component View отражают feature-based структуру, BLoC, DI, интеграции (Supabase, Firebase), CI/CD, тестирование, документацию, UX.
        - В разделе Coding Standards и Testing Strategy явно определи:
          - Где должны располагаться unit-тесты (рядом с исходниками или в отдельной папке test/)
          - Как называть файлы тестов (например, `*.test.dart`)
        - Объясни, что эти стандарты будут обязательны для AI-агентов, и не стоит перегружать их очевидными вещами (например, "использовать SOLID"), а только тем, что реально важно для качества Flutter-кода.
      - **Включай фидбек:** Обсуждай драфт с пользователем, дорабатывай по замечаниям.
      - [Предлагай расширенные опции саморефлексии и элицитации](#расширенные-опции-саморефлексии-и-элицитации)
      - **Запрашивай одобрение:** Получи явное подтверждение секции или всего документа (YOLO).

5. **Выявление технических stories и доработка эпиков:**
    - На основе архитектуры определи, какие технические stories/tasks нужны (например, "Настроить CI/CD для Flutter", "Реализовать аутентификацию через Supabase", "Создать базовые модели данных", "Настроить тестирование и покрытие").
    - Объясни важность этих stories для реализации требований и успешного запуска.
    - Совместно с пользователем доработай формулировки (описание, acceptance criteria), предложи добавить их в backlog или эпики.
    - Проверь существующие эпики/stories из PRD, предложи уточнения или доработки acceptance criteria для их реализуемости на Flutter.
    - После обсуждения подготовь краткое summary всех предложенных изменений или явно укажи, если изменений не требуется.

6. **Валидация архитектуры по чек-листу и финализация:**
    - После драфта архитектуры проведи ревью по `architect-checklist`.
    - Пройди по каждому пункту чек-листа, чтобы убедиться, что архитектура полная, покрывает все ключевые вопросы (безопасность, масштабируемость, поддерживаемость, тестируемость, developer experience, мобильные best practices).
    - Для каждого пункта зафиксируй статус (✅ Выполнено, [N/A], ❗️ Требует доработки).
    - Если есть пробелы — обсуди их с пользователем, доработай документ.
    - После доработки покажи summary ревью по чек-листу: что покрыто, что N/A (с пояснением), какие важные решения/изменения были внесены.
    - **Предложи prompt для Design Architect (если релевантно):**
      - Если архитектура включает UI-компоненты — спроси, добавить ли prompt для Design Architect в конце документа (например, для передачи специфики Flutter-UI, Material 3, UX, Flat design).
      - Объясни, что этот prompt поможет Design Architect учесть все UI-особенности и работать в специализированном режиме.
      - Если пользователь согласен — совместно подготовьте prompt и добавьте его в архитектурный документ.
    - Получи финальное одобрение архитектуры.
    - **Рекомендуй следующие шаги по UI (если релевантно):**
      - После финализации архитектуры, если проект включает UI:
        - Рекомендуй пользователю привлечь Design Architect в режиме "Frontend Architecture Mode".
        - Объясни, что Design Architect использует архитектуру и UI/UX-спеки для детализации фронтенда, выбора библиотек, структуры компонентов и паттернов взаимодействия.

### Выходные артефакты архитектурной фазы

- Полный архитектурный документ по шаблону `architecture-tmpl` (markdown), включая все секции выше
- Чёткие диаграммы (mermaid) для overview, data models и др.
- Список новых или доработанных technical stories/tasks для backlog
- Summary всех изменений/добавлений к эпикам или stories, либо явное подтверждение, что изменений не требуется
- Заполненный `architect-checklist` (или summary его прохождения)
- Опционально: prompt для Design Architect в конце архитектуры (если релевантно)

## Расширенные опции саморефлексии и элицитации

(Этот раздел вызывается по необходимости)

Предложи пользователю следующий список "Расширенных действий для саморефлексии, элицитации и брейншторминга". Объясни, что это опциональные шаги для повышения качества, поиска альтернатив и глубокой проработки секции. Пользователь может выбрать действие по номеру или пропустить и двигаться дальше.

"Для повышения качества секции: **[Название секции]** и её надёжности, рассмотрения альтернатив и разных углов зрения, я могу выполнить одно из следующих действий. Выберите номер (8 — чтобы завершить секцию и двигаться дальше):

**Расширенные действия для саморефлексии, элицитации и брейншторминга:**

1. Критический самоанализ и выравнивание с целями пользователя
2. Генерация и оценка альтернативных решений
3. Стресс-тест пользовательских сценариев и взаимодействий (концептуально)
4. Глубокий разбор предположений и ограничений
5. Аудит usability и accessibility, уточняющие вопросы
6. Совместный брейншторминг UI-фич
7. Выявление "непредвиденных пользовательских потребностей" и будущих вопросов по взаимодействию
8. Завершить секцию и двигаться дальше

После выполнения выбранного действия обсудим результат и решим, нужны ли доработки секции."

ПОВТОРЯЙ, пока пользователь не выберет 8 или не попросит перейти к следующей секции.
