# Задача создания следующей User Story

## Назначение

Определить следующую логическую user story на основе прогресса проекта и структуры эпиков, затем подготовить полноценный, самодостаточный и готовый к реализации файл story по шаблону `Story Template`. Задача — обогатить story всей необходимой технической информацией, требованиями и критериями приёмки, чтобы Developer Agent мог приступить к реализации без дополнительных исследований.

## Входные данные для задачи

- Доступ к документации проекта, в частности:
  - `docs/index.md` (далее — "Индексный документ")
  - Все файлы эпиков (например, `docs/epic-{n}.md` — далее "Файлы эпиков")
  - Существующие story-файлы в `docs/stories/`
  - Основной PRD (далее — "Документ PRD") в `docs/prd.md`
  - Основной архитектурный документ (далее — "Архитектурный документ")
  - Документ фронтенд-архитектуры (если актуально)
  - Гайд по структуре проекта (`docs/project-structure.md`)
  - Документ с операционными правилами (`docs/operational-guidelines.md`)
  - Документ по стеку технологий (`docs/tech-stack.md`)
  - Документ с моделями данных (см. ссылки в Индексном документе)
  - API Reference (см. ссылки в Индексном документе)
  - UI/UX-спецификации, гайды по стилю, гайды по компонентам (если актуально)
- Шаблон story: `bmad-agent/templates/story-tmpl.md`
- Чек-лист: `bmad-agent/checklists/story-draft-checklist.md`
- Подтверждение пользователя на продолжение создания story и, при необходимости, согласие на override при наличии незавершённых story.

## Инструкция по выполнению задачи

### 1. Определить следующую story для подготовки

- Просмотрите `docs/stories/` и найдите story-файл с максимальным номером.
- **Если такой файл найден (`{lastEpicNum}.{lastStoryNum}.story.md`):**
  - Проверьте, что его статус — 'Done' (или эквивалент).
  - Если статус не 'Done', покажите пользователю предупреждение:

    ``` text
    ВНИМАНИЕ: Найдена незавершённая story:
    Файл: {lastEpicNum}.{lastStoryNum}.story.md
    Статус: [текущий статус]

    Выберите действие:
    1. Просмотреть детали story (инструкция пользователю, агент не выводит детали)
    2. Отменить создание новой story
    3. Принять риск и продолжить создание следующей story в черновике

    Пожалуйста, выберите опцию (1/2/3):
    ```

  - Продолжайте только если выбран вариант 3 (Override) или последняя story была 'Done'.
  - Если продолжаете: проверьте в файле эпика `{lastEpicNum}` наличие story с номером `{lastStoryNum + 1}`. Если она есть и её предусловия (по файлу эпика) выполнены — это следующая story.
  - Иначе (story не найдена или предусловия не выполнены): следующая story — первая в следующем эпике (`docs/epic-{lastEpicNum + 1}.md` и далее), чьи предусловия выполнены.
- **Если в `docs/stories/` нет story-файлов:**
  - Следующая story — первая в `docs/epic-1.md` (затем `epic-2.md` и т.д.), чьи предусловия выполнены.
- Если подходящей story с выполненными предусловиями нет — сообщите пользователю, что создание story заблокировано, укажите, какие предусловия не выполнены. Остановите задачу.
- Сообщите пользователю: "Определена следующая story для подготовки: {epicNum}.{storyNum} — {Story Title}".

### 2. Собрать основные требования story (из файла эпика)

- Для выбранной story откройте её родительский файл эпика.
- Извлеките: точный заголовок, полное описание цели/user story, исходный список требований, все Acceptance Criteria (AC), любые заранее определённые задачи высокого уровня.
- Зафиксируйте этот исходный объём для последующего анализа отклонений.

### 3. Собрать и синтезировать технический контекст для Developer Agent

- <critical_rule>Системно используйте Индексный документ (`docs/index.md`) как основной источник для поиска всех подробных документов, релевантных реализации текущей story.</critical_rule>
- Внимательно изучите PRD, архитектурные документы (основной и фронтенд, если UI-story).
- Ориентируясь на Индексный документ и специфику story, найдите и проанализируйте:
  - Документ моделей данных (структура, правила валидации).
  - API Reference (endpoints, схемы запросов/ответов, авторизация).
  - Архитектурные паттерны/компоненты из архитектурных документов.
  - UI/UX-спецификации, гайды по стилю, гайды по компонентам (для UI-story).
  - Особенности из документа по стеку технологий (версии, конфигурации, DI, BLoC, Supabase, Firebase, CI/CD, тестирование, документация, UX, accessibility, мобильные best practices).
  - Актуальные разделы операционных правил (например, обработка ошибок, требования безопасности, особенности работы с данными в этой story).
- Цель — собрать все детали, которые нужны для реализации story без дополнительных поисков. Зафиксируйте расхождения между эпиком и деталями для "Анализа отклонений".

### 4. Проверить соответствие структуре проекта

- Сверьте требования story и предполагаемые изменения файлов с гайдом по структуре проекта (и фронтенда, если актуально).
- Убедитесь, что все пути, компоненты, модули соответствуют принятой структуре (feature-based, разделение по слоям, DI, BLoC, интеграции, тесты, документация).
- Зафиксируйте любые конфликты, неясности или неописанные компоненты/пути в разделе "Заметки по структуре проекта" внутри черновика story.

### 5. Заполнить шаблон story с полным контекстом

- Создайте новый файл: `docs/stories/{epicNum}.{storyNum}.story.md`.
- Используйте шаблон story для структуры.
- Заполните:
  - Story `{EpicNum}.{StoryNum}: {Краткий заголовок из файла эпика}`
  - `Status: Draft`
  - `Story` (user story из эпика)
  - `Acceptance Criteria (AC)` (из эпика, при необходимости уточните по собранному контексту)
- **Секция `Dev Technical Guidance` (КРИТИЧЕСКИ ВАЖНО):**
  - На основе собранного контекста (шаги 3 и 4) добавьте краткие, но ключевые сведения: структуры данных, детали API, точные ссылки на _конкретные разделы_ других документов (например, "см. Data Models Doc#User-Schema-ValidationRules"), пояснения по архитектурным паттернам применительно к _этой story_.
  - Для UI-story — ссылки на гайды по компонентам/стилю, относящиеся к _элементам этой story_.
  - Цель — сделать эту секцию основным источником story-специфичного технического контекста для Developer Agent.
- **Секция `Tasks / Subtasks`:**
  - Сгенерируйте подробный, последовательный список технических задач и подзадач для реализации story, с учётом всего собранного контекста.
  - Привязывайте задачи к AC, где это уместно (например, `Task 1 (AC: 1, 3)`).
- Добавьте заметки по соответствию структуре проекта или найденным расхождениям (шаг 4).
- Подготовьте раздел "Анализ отклонений" на основе расхождений, выявленных на шаге 3.

---

**После внесения изменений рекомендуется перезагрузить приложение для применения новых инструкций.**
